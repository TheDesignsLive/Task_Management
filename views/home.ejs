<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Home</title>

<style>

  /* ===== PREVENT FULL PAGE SCROLL ===== */
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;   /* ✅ Prevent page scroll */
    font-family: Arial, sans-serif;
    background-color: #3C3A3A;
  }

  .layout {
    display: flex;
    height: calc(100% - 60px); /* ✅ Adjust if navbar is 60px */
  }

  .sidebar-container {
    width: 55px;
  }

  .main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .sub-header {
    display: flex;
    background-color: #CDF4F4;
    padding: 10px;
    gap: 10px;
    align-items: center;
  }

  .sub-header .task { flex: 4; padding: 8px; text-align: center; border-radius: 5px; background-color: #CDF4F4; }
  .sub-header .change,
  .sub-header .update { flex: 1.5; padding: 8px; text-align: center; border-radius: 5px; background-color: #CDF4F4; }
  .sub-header .other-task { flex: 2; padding: 8px; text-align: center; border-radius: 5px; background-color: #CDF4F4; }

  /* ===== CONTENT WRAPPER ===== */
  .content-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;  /*  important */
  }

  /* ===== TASK SECTION ===== */
  .task-container {
    flex: 1;
    display: flex;
    overflow: hidden;   /*  prevents extra scroll */
  }

  .task-box {
    padding: 10px;
    overflow-y: auto;   /*  Scroll only when content overflows */
  }

  .task-main { flex: 4; }
  .task-change { flex: 1.5; }
  .task-update { flex: 1.5; }
  .task-other { flex: 2; }

  .vertical-line {
    width: 1.8px;
    background-color: #7C7B7B;
  }

  /* ===== COMPLETED SECTION (Fixed height) ===== */
  .completed-header {
    margin-left: 10px;
    margin-right: 10px;
    border-radius: 100px;
    background-color: #0F8989;
    padding: 8px 20px;
    font-weight: bold;
    color: white;
  }

  .completed-section {
    height: 150px;
    overflow-y: auto;  /* Optional scroll for completed */
    padding: 10px;
    background-color: #2E2D2D;
    color: white;
  }
  /* ===== TASK BOX ===== */
.task-item {
  padding: 6px;
  margin: 6px 0;
  background-color: #444;
  color: #fff;
  border-radius: 4px;
  cursor: move;
}

/* Completed Task */
.completed-task {
  opacity: 0.6;
  cursor: default;
}

/* Layout row */
.task-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

/* Checkbox base style */
.task-checkbox {
  width: 16px;
  height: 16px;
  appearance: none;
  border: 2px solid white;
  border-radius: 3px;
  background: transparent;
  cursor: pointer;
  position: relative;
}

/* Checked style */
.task-checkbox:checked {
  background-color: white;
}

/* ===== PRIORITY COLORS ===== */
.priority-red {
  border-color: #ff4d4d;
}

.priority-yellow {
  border-color: #ffd633;
}

.priority-blue {
  border-color: #4da6ff;
}
/* Keep checkbox color visible when checked */
.task-checkbox:checked {
  background-color: transparent; /* don't override border color */
}

/* Optional: Add a small checkmark to show it is checked */
.task-checkbox:checked::after {
  content: "✔";
  position: absolute;
  font-size: 12px;
  top: 0;
  left: 2px;
  color: inherit; /* will match border color */
}


</style>
</head>

<body>
<%- include('navbar') %>

<div class="layout">

  <div class="sidebar-container">
    <% if (show_sidebar === 'sidebar') { %>
      <%- include('sidebar') %>
    <% } else if (show_sidebar === 'Usersidebar') { %>
      <%- include('user_sidebar') %>
    <% } %>
  </div>

  <div class="main-content">

    <div class="sub-header">
      <div class="task">Task</div>
      <div class="change">Change</div>
      <div class="update">Update</div>
      <div class="other-task">Others</div>
    </div>

    <div class="content-wrapper">

      <div class="task-container">

        <div class="task-box task-main" id="task-section"></div>
        <div class="vertical-line"></div>
        <div class="task-box task-change" id="change-section"></div>
        <div class="vertical-line"></div>
        <div class="task-box task-update" id="update-section"></div>
        <div class="vertical-line"></div>
        <div class="task-box task-other" id="other-section"></div>

      </div>

      <div class="completed-header">Completed Tasks</div>
      <div class="completed-section" id="completed-section"></div>

    </div>

  </div>
</div>
<script>
  const tasks = <%- JSON.stringify(tasks) %>;

  function formatDate(dateStr) {
    if (!dateStr) return '';

    const today = new Date();
    const tomorrow = new Date();
    tomorrow.setDate(today.getDate() + 1);

    const taskDate = new Date(dateStr);

    today.setHours(0,0,0,0);
    tomorrow.setHours(0,0,0,0);
    taskDate.setHours(0,0,0,0);

    if (taskDate.getTime() === today.getTime()) {
      return "Today";
    } else if (taskDate.getTime() === tomorrow.getTime()) {
      return "Tom";
    } else {
      const options = { day: '2-digit', month: 'short' };
      return taskDate.toLocaleDateString('en-GB', options);
    }
  }

  function getPriorityClass(priority) {
    if (!priority) return '';

    if (priority.toUpperCase() === 'RED') return 'priority-red';
    if (priority.toUpperCase() === 'YELLOW') return 'priority-yellow';
    if (priority.toUpperCase() === 'BLUE') return 'priority-blue';

    return '';
  }

  function createTaskElement(task) {
    const div = document.createElement('div');
    div.className = 'task-item';
    div.dataset.id = task.id;

    if (task.status === 'COMPLETED') {
      div.classList.add('completed-task');
    }

    const priorityClass = getPriorityClass(task.priority);

    div.innerHTML = `
      <div class="task-row">
        <input type="checkbox"
          class="task-checkbox ${priorityClass}"
          ${task.status === 'COMPLETED' ? 'checked' : ''} />

        <span style="flex:1; margin-left:8px;">
          ${task.title}
        </span>

        <span style="min-width:60px; text-align:right;">
          ${formatDate(task.due_date)}
        </span>
      </div>
    `;

    div.draggable = true;

    const checkbox = div.querySelector('input.task-checkbox');
    checkbox.addEventListener('change', (e) => {
      const isChecked = e.target.checked;
      if (isChecked) {
        // Move to Completed
        updateTaskStatus(task.id, 'COMPLETED');
        div.classList.add('completed-task');
        div.remove();
        document.getElementById('completed-section').appendChild(div);
      } else {
        // Move back to TASK section
        updateTaskStatus(task.id, 'PENDING'); // or 'INCOMPLETE' depending on your DB
        div.classList.remove('completed-task');
        div.remove();
        document.getElementById('task-section').appendChild(div);
      }
    });

    return div;
  }

  function updateTaskStatus(id, status) {
    fetch('/update-task-status', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, status })
    });
  }

  function updateTaskSection(id, section) {
    fetch('/update-task-section', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, section })
    });
  }

  function initSections() {
    const sections = {
      'TASK': document.getElementById('task-section'),
      'CHANGES': document.getElementById('change-section'),
      'UPDATE': document.getElementById('update-section'),
      'OTHERS': document.getElementById('other-section'),
      'COMPLETED': document.getElementById('completed-section')
    };

    tasks.forEach(task => {
      const el = createTaskElement(task);

      if (task.status === 'COMPLETED') {
        sections['COMPLETED'].appendChild(el);
      } else if (task.section === 'TASK') {
        sections['TASK'].appendChild(el);
      } else if (task.section === 'CHANGES') {
        sections['CHANGES'].appendChild(el);
      } else if (task.section === 'UPDATE') {
        sections['UPDATE'].appendChild(el);
      } else {
        sections['OTHERS'].appendChild(el);
      }
    });
  }

  function enableDragAndDrop() {
    const containers = {
      'task-section': 'TASK',
      'change-section': 'CHANGES',
      'update-section': 'UPDATE'
      // intentionally not allowing drop in OTHERS
    };

    document.querySelectorAll('.task-item').forEach(item => {
      item.addEventListener('dragstart', () => item.classList.add('dragging'));
      item.addEventListener('dragend', () => item.classList.remove('dragging'));
    });

    Object.keys(containers).forEach(containerId => {
      const container = document.getElementById(containerId);

      container.addEventListener('dragover', (e) => e.preventDefault());

      container.addEventListener('drop', (e) => {
        e.preventDefault();
        const dragging = document.querySelector('.dragging');
        if (!dragging) return;

        container.appendChild(dragging);
        const newSection = containers[containerId];
        updateTaskSection(dragging.dataset.id, newSection);
      });
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    initSections();
    enableDragAndDrop();
  });
</script>




</body>
</html>
