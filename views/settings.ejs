<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Settings</title>

<style>
body{margin:0;font-family:Arial;background:#3C3A3A;}
.layout{display:flex;min-height:calc(100vh - 60px);}
.sidebar-container{width:55px;}
.main-content{flex:1;padding:20px;background:#f4f4f4;}

.settings-menu{background:#fff;border-radius:8px;overflow:hidden;margin-bottom:20px;}
.settings-item{padding:15px;border-bottom:1px solid #eee;cursor:pointer;}
.settings-item:hover{background:#f0f0f0;}
.settings-item.danger { color: #d9534f; font-weight: bold; }
.settings-item.danger:hover { background: #fdf2f2; }

.card{display:none;background:#fff;padding:20px;border-radius:8px;}
.card.active{display:block;}

input{width:100%;padding:8px;margin:6px 0;box-sizing:border-box;}
button{padding:10px;background:#095959;color:#fff;border:none;cursor:pointer;margin-top:5px;border-radius:4px;}
button:hover{background:#0b7373;}

/* === DIALOG MODAL STYLES === */
.modal, .dialog-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.65); backdrop-filter: blur(4px);
    display: none; justify-content: center; align-items: center; z-index: 999;
}
.modal-content, .dialog-box {
    background: #fff; width: 340px; padding: 25px; border-radius: 12px;
    position: relative; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.25);
}
.close-btn {
    position: absolute; top: 8px; right: 12px; cursor: pointer; font-size: 18px; font-weight: bold; color: #555;
}
.close-btn:hover { color: red; }

/* Modal Buttons */
.modal-buttons { margin-top: 25px; display: flex; justify-content: space-between; gap: 10px; }
.btn { flex: 1; padding: 10px 0; border: none; cursor: pointer; border-radius: 6px; font-size: 14px; font-weight: 500; text-decoration: none; display: inline-block;}
.btn-danger { background: linear-gradient(135deg, #d9534f, #c9302c); color: #fff; }
.btn-danger:hover { background: linear-gradient(135deg, #c9302c, #a71d2a); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(217, 83, 79, 0.4); }
.btn-cancel { background-color: #f1f1f1; color: #333; }
.btn-cancel:hover { background-color: #ddd; transform: translateY(-2px); }
</style>
</head>

<body>

<%- include('navbar') %>

<div class="layout">

<div class="sidebar-container">
<% if (show_sidebar === 'sidebar') { %>
<%- include('sidebar') %>
<% } else { %>
<%- include('user_sidebar') %>
<% } %>
</div>

<div class="main-content">

<h2>Settings</h2>

<div class="settings-menu">
    <div class="settings-item" onclick="openCard('passwordCard')">Change Password</div>
    <div class="settings-item" onclick="openEmailDialog()">Change Gmail</div>
    <div class="settings-item danger" onclick="openDeleteDialog()">Delete Profile</div>
    <div class="settings-item danger" onclick="openLogoutModal()">Logout</div>
</div>

<div id="passwordCard" class="card">
<h3>Change Password</h3>

<form method="POST" action="/settings/change-password">
<input type="password" name="current_password" placeholder="Current Password" required>
<input type="password" name="new_password" placeholder="New Password" required>
<input type="password" name="confirm_password" placeholder="Confirm Password" required>
<button>Change Password</button>
</form>
</div>

</div>
</div>

<div id="emailDialog" class="dialog-overlay">
    <div class="dialog-box">
        <span class="close-btn" onclick="closeEmailDialog()">âœ–</span>
        <h3 style="margin-top:0;">Change Gmail</h3>

        <div id="email-step1">
            <p style="font-size: 14px; color: #555;">Current Email:</p>
            <p style="font-size: 16px;"><strong><%= session.email %></strong></p>
            <button type="button" style="width:100%; margin-top:10px;" onclick="sendOtpToCurrent('<%= session.email %>')">Send OTP to Current Email</button>
        </div>

        <div id="email-step2" style="display:none;">
            <p style="color:green; font-size:14px;">OTP sent to current email.</p>
            <input type="text" id="currentOtpInput" placeholder="Enter OTP">
            <button type="button" style="width:100%; margin-top:10px;" onclick="verifyCurrentOtp()">Confirm OTP</button>
        </div>

        <div id="email-step3" style="display:none;">
            <p style="font-size: 14px; color: #555;">Current email verified.</p>
            <input type="email" id="newEmailInput" placeholder="Enter New Email Address" required>
            <button type="button" style="width:100%; margin-top:10px;" onclick="sendOtpToNew()">Send OTP to New Email</button>
        </div>

        <div id="email-step4" style="display:none;">
            <p style="color:green; font-size:14px;">OTP sent to new email.</p>
            <form method="POST" action="/settings/change-email" id="changeEmailForm" onsubmit="return verifyNewOtpAndSubmit(event)">
                <input type="hidden" name="new_email" id="finalNewEmail">
                <input type="text" id="newOtpInput" placeholder="Enter OTP" required>
                <button type="submit" style="width:100%; margin-top:10px;">Confirm & Change Gmail</button>
            </form>
        </div>
    </div>
</div>

<div id="logoutModal" class="modal">
  <div class="modal-content">
    <h3 style="margin-top:0;">Confirm Logout</h3>
    <p>Logout from <br><strong><%= session.email %></strong> ?</p>
    <div class="modal-buttons">
      <a href="/logout" class="btn btn-danger">Logout</a>
      <button onclick="closeLogoutModal()" class="btn btn-cancel">Cancel</button>
    </div>
  </div>
</div>

<div id="adminDeleteModal" class="modal">
  <div class="modal-content">
    <h3 style="margin-top:0; color:#d9534f;">Delete Profile</h3>
    <p style="font-size:14px; color:#555;">Are you sure you want to delete your account? All your employee accounts will be deleted and there is no recovery.</p>
    <div class="modal-buttons">
      <a href="/settings/delete-profile" class="btn btn-danger">Yes, Delete</a>
      <button onclick="closeDeleteDialogs()" class="btn btn-cancel">Cancel</button>
    </div>
  </div>
</div>

<div id="userCannotDeleteModal" class="modal">
  <div class="modal-content">
    <h3 style="margin-top:0; color:#d9534f;">Action Denied</h3>
    <p style="font-size:14px; color:#555;">You cannot delete this account because you didn't create it. Please contact your admin to remove your profile.</p>
    <div class="modal-buttons">
      <button onclick="closeDeleteDialogs()" class="btn btn-cancel" style="width:100%;">Okay</button>
    </div>
  </div>
</div>

<script>
function openCard(id){
    document.querySelectorAll('.card').forEach(c=>c.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

// === LOGOUT LOGIC ===
function openLogoutModal() { document.getElementById('logoutModal').style.display = 'flex'; }
function closeLogoutModal() { document.getElementById('logoutModal').style.display = 'none'; }

// === DELETE PROFILE LOGIC ===
function openDeleteDialog() { 
    // Check role dynamically from EJS to show the correct modal
    const userRole = "<%= session.role %>"; 
    
    if (userRole === "admin") {
        document.getElementById('adminDeleteModal').style.display = 'flex'; 
    } else {
        document.getElementById('userCannotDeleteModal').style.display = 'flex';
    }
}
function closeDeleteDialogs() { 
    document.getElementById('adminDeleteModal').style.display = 'none'; 
    document.getElementById('userCannotDeleteModal').style.display = 'none'; 
}

// === CHANGE GMAIL LOGIC ===
function openEmailDialog() {
    document.getElementById('emailDialog').style.display = 'flex';
    document.getElementById('email-step1').style.display = 'block';
    document.getElementById('email-step2').style.display = 'none';
    document.getElementById('email-step3').style.display = 'none';
    document.getElementById('email-step4').style.display = 'none';
    document.getElementById('currentOtpInput').value = '';
    document.getElementById('newEmailInput').value = '';
    document.getElementById('newOtpInput').value = '';
}
function closeEmailDialog() { document.getElementById('emailDialog').style.display = 'none'; }

let generatedCurrentOtp = "";
let generatedNewOtp = "";

function generateOtp() { return Math.floor(100000 + Math.random() * 900000).toString(); }

async function sendOtpToCurrent(email) {
    if(!email || email.trim() === '') return alert("Current email not found.");
    generatedCurrentOtp = generateOtp();
    const res = await fetch('/forgot-password/send-otp', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contact: email, otp: generatedCurrentOtp, sent_for: 'change_email' })
    });
    const data = await res.json();
    if (data.status === 'sent') {
        document.getElementById('email-step1').style.display = 'none';
        document.getElementById('email-step2').style.display = 'block';
    } else alert('Failed to send OTP');
}

function verifyCurrentOtp() {
    if (document.getElementById('currentOtpInput').value === generatedCurrentOtp) {
        document.getElementById('email-step2').style.display = 'none';
        document.getElementById('email-step3').style.display = 'block';
    } else alert('Invalid OTP. Please try again.');
}

async function sendOtpToNew() {
    const newEmail = document.getElementById('newEmailInput').value;
    if(!newEmail || !newEmail.includes('@')) return alert("Please enter a valid new email address");
    generatedNewOtp = generateOtp();
    const res = await fetch('/forgot-password/send-otp', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contact: newEmail, otp: generatedNewOtp, sent_for: 'change_email' })
    });
    const data = await res.json();
    if (data.status === 'sent') {
        document.getElementById('finalNewEmail').value = newEmail;
        document.getElementById('email-step3').style.display = 'none';
        document.getElementById('email-step4').style.display = 'block';
    } else alert('Failed to send OTP');
}

function verifyNewOtpAndSubmit(e) {
    if (document.getElementById('newOtpInput').value !== generatedNewOtp) {
        e.preventDefault(); alert('Invalid OTP. Please try again.'); return false;
    }
    return true; 
}
</script>

</body>
</html>